<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<script src="libsignal-protocol.js"></script>
<script src="InMemorySignalProtocolStore.js"></script>
<script src="helpers.js"></script>
<script src="base64-binary.js"></script>
<script>
    var KeyHelper = libsignal.KeyHelper;

    function generateIdentity(store) {
        return Promise.all([
            KeyHelper.generateIdentityKeyPair(),
            KeyHelper.generateRegistrationId(),
        ]).then(function(result) {
            store.put('identityKey', result[0]);
            store.put('registrationId', result[1]);
        });
    }

    function generatePreKeyBundle(store, preKeyId, signedPreKeyId) {
        return Promise.all([
            store.getIdentityKeyPair(),
            store.getLocalRegistrationId()
        ]).then(function(result) {
            var identity = result[0];
            var registrationId = result[1];

            return Promise.all([
                KeyHelper.generatePreKey(preKeyId),
                KeyHelper.generateSignedPreKey(identity, signedPreKeyId),
            ]).then(function(keys) {
                var preKey = keys[0];
                var signedPreKey = keys[1];

                store.storePreKey(preKeyId, preKey.keyPair);
                store.storeSignedPreKey(signedPreKeyId, signedPreKey.keyPair);

                return {
                    identityKey: identity.pubKey,
                    registrationId : registrationId,
                    preKey:  {
                        keyId     : preKeyId,
                        publicKey : preKey.keyPair.pubKey
                    },
                    signedPreKey: {
                        keyId     : signedPreKeyId,
                        publicKey : signedPreKey.keyPair.pubKey,
                        signature : signedPreKey.signature
                    }
                };
            });
        });
    }

    var ALICE_ADDRESS = new libsignal.SignalProtocolAddress("xxxxxxxxx", 1);
    var BOB_ADDRESS   = new libsignal.SignalProtocolAddress("yyyyyyyyyyyyy", 1);

    var aliceStore = new SignalProtocolStore();

    var bobStore = new SignalProtocolStore();
    var bobPreKeyId = 1337;
    var bobSignedKeyId = 1;

    Promise.all([
        generateIdentity(aliceStore),
        generateIdentity(bobStore)
    ]).then(function() {
        return generatePreKeyBundle(bobStore, bobPreKeyId, bobSignedKeyId);
    }).then(function(preKeyBundle) {
        //
        console.log(preKeyBundle['identityKey'].toString());
        preKeyBundle['identityKey'] = base64ArrayBuffer(preKeyBundle['identityKey']);
        preKeyBundle['preKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['preKey']['publicKey']);
        preKeyBundle['signedPreKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['publicKey']);
        preKeyBundle['signedPreKey']['signature'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['signature']);

        console.log(preKeyBundle);

        json = JSON.stringify(preKeyBundle);

        console.log(json);

        newPreKeyBundle = JSON.parse(json);

        console.log(preKeyBundle);

        newPreKeyBundle['identityKey'] = Base64Binary.decodeArrayBuffer(newPreKeyBundle['identityKey']);
        newPreKeyBundle['preKey']['publicKey'] = Base64Binary.decodeArrayBuffer(newPreKeyBundle['preKey']['publicKey']);
        newPreKeyBundle['signedPreKey']['publicKey'] = Base64Binary.decodeArrayBuffer(newPreKeyBundle['signedPreKey']['publicKey']);
        newPreKeyBundle['signedPreKey']['signature'] = Base64Binary.decodeArrayBuffer(newPreKeyBundle['signedPreKey']['signature']);

        console.log(preKeyBundle);
        //

        var builder = new libsignal.SessionBuilder(aliceStore, BOB_ADDRESS);
        return builder.processPreKey(preKeyBundle).then(function() {

            var originalMessage = util.toArrayBuffer("my message ......");
            var aliceSessionCipher = new libsignal.SessionCipher(aliceStore, BOB_ADDRESS);
            var bobSessionCipher = new libsignal.SessionCipher(bobStore, ALICE_ADDRESS);

            aliceSessionCipher.encrypt(originalMessage).then(function(ciphertext) {

                console.log(ciphertext);

                // check for ciphertext.type to be 3 which includes the PREKEY_BUNDLE
                return bobSessionCipher.decryptPreKeyWhisperMessage(ciphertext.body, 'binary');

            }).then(function(plaintext) {

                var enc = new TextDecoder("utf-8");

                console.log(enc.decode(plaintext));

            });

            bobSessionCipher.encrypt(originalMessage).then(function(ciphertext) {

                return aliceSessionCipher.decryptWhisperMessage(ciphertext.body, 'binary');

            }).then(function(plaintext) {

                assertEqualArrayBuffers(plaintext, originalMessage);

            });

        });
    });

    function equal (buf1, buf2)
    {
        if (buf1.byteLength != buf2.byteLength) return false;
        var dv1 = new Int8Array(buf1);
        var dv2 = new Int8Array(buf2);
        for (var i = 0 ; i != buf1.byteLength ; i++)
        {
            if (dv1[i] != dv2[i]) return false;
        }
        return true;
    }
</script>
</body>
</html>