<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E2EMessenger</title>
</head>
<body>
<div id="log"></div>
<div id="connection-div" style="display: none;">
    <p>Your ID is <b id="connection-id"></b>. If you are the receiver, please give this ID to the sender. If you are the sender, please ask the receiver for the ID and type it below. </p>
    <form id="connection-form">
        <label for="receiver-id">Receiver ID: </label>
        <input type="text" id="receiver-id">
        <input type="submit" value="Connect">
    </form>

</div>

<script src="libsignal-protocol.js"></script>
<script src="InMemorySignalProtocolStore.js"></script>
<script src="main.js"></script>
<script src="base64-binary.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    let store = new SignalProtocolStore();

    let init = function() {
        $("#log").append('<p id="gingPKB">Generating PreKeyBundle ...... </p>');
        generateIdentity(store).then(function() {
            let preKeyId = 1;
            let signedKeyId = 1;
            return generatePreKeyBundle(store, preKeyId, signedKeyId);
        }).then(function(preKeyBundle) {
            preKeyBundle['identityKey'] = base64ArrayBuffer(preKeyBundle['identityKey']);
            preKeyBundle['preKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['preKey']['publicKey']);
            preKeyBundle['signedPreKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['publicKey']);
            preKeyBundle['signedPreKey']['signature'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['signature']);

            $("#gingPKB").append("Done");

            sendPreKeyBundle(preKeyBundle);
        })
    };

    let sendPreKeyBundle = function(preKeyBundle) {
        $("#log").append('<p id="singPKB">Sending PreKeyBundle and Getting ID ...... </p>');

        fetch('https://e2e-server.herokuapp.com/register', {
            method: 'POST',
            body: JSON.stringify(preKeyBundle)
        }).then(function (response) {
            if (!response.ok) {
                // TODO:
            } else {
                $("#singPKB").append("Done");

                return response.json()
            }
        }).then(function (json) {
            showID(json['id']);
        })
    };

    let showID = function(id) {
        $("#log").append('<p>Your ID is <b>' + id +'</b></p>');
        $("#connection-id").html(id);

        $("#connection-div").slideDown();
    };

    let sendRequest = function() {
        if ($("#receiver-id").val() === '') {
            alert("Please type Receiver ID!");
            return false;
        }

        return false;
    };

    $("#connection-form").on("submit", sendRequest);

    init();
</script>
</body>
</html>