<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E2EMessenger</title>
</head>
<body>
<div id="connection-div" style="display: none;">
    <p>Your ID is <b id="connection-id"></b>. If you are the receiver, please give this ID to the sender. If you are the sender, please ask the receiver for the ID and type it below. </p>
    <form id="connection-form">
        <label for="receiver-id">Receiver ID: </label>
        <input type="text" id="receiver-id">
        <input type="submit" value="Connect">
    </form>
</div>

<div id="confirm-div" style="display: none;">
    <p>ID <b id="other-id"></b> wants to connect with you. Please verify the ID before confirming. </p>
    <input class="confirm-button" type="button" value="Confirm">
    <input class="confirm-button" type="button" value="Decline">
</div>

<hr>

<div id="log"></div>

<script src="libsignal-protocol.js"></script>
<script src="InMemorySignalProtocolStore.js"></script>
<script src="main.js"></script>
<script src="base64-binary.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    let server = "http://18.221.163.89:8080";

    let store = new SignalProtocolStore();
    let myId = null;
    let otherID = null;
    let myAccessToken = null;
    let requestCount = 0;
    let isReveiver = true;

    let mySessionCipher = null;

    let init = function() {
        $("#log").append('<p id="gingPKB">Generating PreKeyBundle ...... </p>');
        generateIdentity(store).then(function() {
            let preKeyId = 1;
            let signedKeyId = 1;
            return generatePreKeyBundle(store, preKeyId, signedKeyId);
        }).then(function(preKeyBundle) {
            console.log(preKeyBundle);

            preKeyBundle['identityKey'] = base64ArrayBuffer(preKeyBundle['identityKey']);
            preKeyBundle['preKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['preKey']['publicKey']);
            preKeyBundle['signedPreKey']['publicKey'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['publicKey']);
            preKeyBundle['signedPreKey']['signature'] = base64ArrayBuffer(preKeyBundle['signedPreKey']['signature']);

            $("#gingPKB").append("Done");

            sendPreKeyBundle(preKeyBundle);
        })
    };

    let sendPreKeyBundle = function(preKeyBundle) {
        $("#log").append('<p id="singPKB">Sending PreKeyBundle and Getting ID and AccessToken ...... </p>');

        fetch(server + '/register', {
            method: 'POST',
            body: JSON.stringify(preKeyBundle)
        }).then(function (response) {
            if (!response.ok) {
                // TODO:
            } else {
                $("#singPKB").append("Done");

                return response.json()
            }
        }).then(function (json) {
            myId = json['id'];
            myAccessToken = json['accessToken'];

            showID();

            setTimeout(checkConnectRequest, 3000);
        })
    };

    let showID = function() {
        $("#log").append('<p>Your ID is <b>' + myId +'</b></p>');
        $("#connection-id").html(myId);

        $("#connection-div").slideDown();
    };

    let sendConnectRequest = function() {
        requestCount += 1;

        let value = $("#receiver-id").val();
        if (value === '') {
            alert("Please type Receiver ID!");
            return false;
        }

        if (value === myId) {
            alert("You cannot connect to yourself.");
            return false;
        }

        $("#connection-div").slideUp();

        pid = 'singCR' + requestCount;

        $("#log").append('<p id="' + pid + '">Sending Connection Request ...... </p>');
        fetch(server + '/connect?accessToken=' + myAccessToken, {
            method: 'POST',
            body: JSON.stringify({"receiverId": value})
        }).then(function (response) {
            if (!response.ok) {
                // TODO:
            } else {
                $("#" + pid).append("Done");

                return response.json()
            }
        }).then(function (json) {
            if (json['status'] === 'failed') {
                alert(json['msg']);
            } else {
                isReveiver = false;

                setTimeout(checkConnectResult, 3000);
            }
        });

        return false;
    };

    let checkConnectResult = function() {
        requestCount += 1;

        pid = 'cingCR' + requestCount;
        $("#log").append('<p id="' + pid + '">Checking Request Result ...... </p>');

        fetch(server + '/confirm?accessToken=' + myAccessToken, {
            method: 'GET'
        }).then(function (response) {
            if (!response.ok) {
                // TODO:
            } else {
                return response.json()
            }
        }).then(function (json) {
            if (json['status'] === 'failed') {
                alert(json['msg']);
            } else {
                if ("msg" in json) {
                    $("#" + pid).append(json['msg']);

                    setTimeout(checkConnectResult, 3000);
                } else {
                    if (json["isConfirm"] === false) {
                        $("#log").append('<p>ID <b>' + json['receiverId'] +'</b> declined your request</p>');

                        $("#receiver-id").val("");
                        $("#connection-div").slideDown();

                        isReveiver = true;
                        setTimeout(checkConnectRequest, 3000);
                    } else {
                        $("#log").append('<p>ID <b>' + json['receiverId'] +'</b> accept your request</p>');

                        let preKeyBundle = JSON.parse(json['perKeyBundle']);
                        handlePreKeyBundle(preKeyBundle);
                    }
                }
            }
        });
    };

    let checkConnectRequest = function() {
        if (!isReveiver) return;

        requestCount += 1;

        pid = 'checkCR' + requestCount;
        $("#log").append('<p id="' + pid + '">Checking Connect Request ...... </p>');

        fetch(server + '/connect?accessToken=' + myAccessToken, {
            method: 'GET'
        }).then(function (response) {
            if (!response.ok) {
                // TODO:
            } else {
                return response.json()
            }
        }).then(function (json) {
            if (json['status'] === 'failed') {
                alert(json['msg']);
            } else {
                if ("msg" in json) {
                    $("#" + pid).append(json['msg']);

                    setTimeout(checkConnectRequest, 3000);
                } else {
                    $("#connection-div").slideUp();

                    otherID = json['senderId'];

                    showOtherID();
                }
            }
        });
    };

    let showOtherID = function() {
        $("#log").append('<p>ID <b>' + otherID +'</b> wants to connect with you</p>');
        $("#other-id").html(otherID);

        $("#confirm-div").slideDown();
    };

    let sendConfirm = function(value) {
        $("#confirm-div").slideUp();

        pid = 'singC' + requestCount;

        $("#log").append('<p id="' + pid + '">Sending Confirm ...... </p>');

        if (value === "Confirm") {
            fetch(server + '/confirm?accessToken=' + myAccessToken, {
                method: 'POST',
                body: JSON.stringify({"senderId": otherID, "isConfirm": "True"})
            }).then(function (response) {
                if (!response.ok) {
                    // TODO:
                } else {
                    return response.json();
                }
            }).then(function (json) {
                $("#" + pid).append("Done");

                let preKeyBundle = JSON.parse(json['preKeyBundle'])
                handlePreKeyBundle(preKeyBundle);
            });
        } else {
            fetch(server + '/confirm?accessToken=' + myAccessToken, {
                method: 'POST',
                body: JSON.stringify({"senderId": otherID, "isConfirm": "False"})
            }).then(function (response) {
                if (!response.ok) {
                    // TODO:
                } else {
                    $("#" + pid).append("Done");

                    $("#connection-div").slideDown();

                    setTimeout(checkConnectRequest, 3000);
                }
            })
        }
    };

    let handlePreKeyBundle = function(bundle) {
        console.log(bundle);

        //bundle['identityKey'] = Base64Binary.decodeArrayBuffer(bundle['identityKey']);
        //bundle['preKey']['publicKey'] = Base64Binary.decodeArrayBuffer(bundle['preKey']['publicKey']);
        //bundle['signedPreKey']['publicKey'] = Base64Binary.decodeArrayBuffer(bundle['signedPreKey']['publicKey']);
        //bundle['signedPreKey']['signature'] = Base64Binary.decodeArrayBuffer(bundle['signedPreKey']['signature']);

        // console.log(bundle);

        let my_address = new libsignal.SignalProtocolAddress(myId, 1);
        let other_address = new libsignal.SignalProtocolAddress(otherID, 1);

        let builder = new libsignal.SessionBuilder(store, other_address);

        builder.processPreKey(bundle).then(function() {
            //mySessionCipher = new libsignal.SessionCipher(store, other_address);
        })
    };

    $("#connection-form").on("submit", sendConnectRequest);
    $(".confirm-button").on("click", function() {
        sendConfirm($(this)[0].value);
    });

    init();
</script>
</body>
</html>